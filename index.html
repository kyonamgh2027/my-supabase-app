<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ëŒë´„ ì ê²€ ê´€ë¦¬</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// Supabase ì„¤ì •
const SUPABASE_URL = 'https://nogzefpmsenbcxqlnmjl.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vZ3plZnBtc2VuYmN4cWxubWpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMjMwNzQsImV4cCI6MjA4NTY5OTA3NH0.3N_AbsD0ovXR1c-GXsQ4dfsfJ1ZQXOziCL14MGb3amE';
</script>
<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Malgun Gothic', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
}

.card {
  background: white;
  padding: 30px;
  border-radius: 16px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
  margin-bottom: 20px;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

h2, h3 {
  color: #1f2937;
  margin-bottom: 20px;
  font-weight: 600;
}

h2 {
  font-size: 28px;
  text-align: center;
}

h3 {
  font-size: 24px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.header-icon {
  font-size: 32px;
}

/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
button {
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 15px;
  font-weight: 500;
  transition: all 0.3s ease;
  margin: 5px;
}

button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

button:active:not(:disabled) {
  transform: translateY(0);
}

button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn-blue {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.btn-blue:hover:not(:disabled) {
  background: linear-gradient(135deg, #5568d3 0%, #6a3f8f 100%);
}

.btn-green {
  background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
  color: white;
}

.btn-green:hover:not(:disabled) {
  background: linear-gradient(135deg, #15803d 0%, #166534 100%);
}

.btn-red {
  background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
  color: white;
}

.btn-red:hover:not(:disabled) {
  background: linear-gradient(135deg, #b91c1c 0%, #7f1d1d 100%);
}

.btn-gray {
  background: #e5e7eb;
  color: #374151;
}

.btn-gray:hover:not(:disabled) {
  background: #d1d5db;
}

/* ì…ë ¥ í•„ë“œ */
input, select, textarea {
  width: 100%;
  padding: 12px 16px;
  margin: 8px 0;
  border-radius: 8px;
  border: 2px solid #e5e7eb;
  font-size: 14px;
  transition: all 0.3s ease;
  font-family: inherit;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

textarea {
  min-height: 100px;
  resize: vertical;
}

/* ì„¹ì…˜ */
.section {
  background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
  padding: 20px;
  margin: 15px 0;
  border-radius: 12px;
  border-left: 4px solid #667eea;
}

.section b {
  display: block;
  font-size: 18px;
  color: #1f2937;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-icon {
  font-size: 22px;
}

/* ë¼ë””ì˜¤ ë²„íŠ¼ */
.radio {
  margin: 10px 0;
  padding: 10px;
  background: white;
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 15px;
  flex-wrap: wrap;
}

.radio-label {
  font-weight: 500;
  color: #374151;
  min-width: 120px;
}

.radio label {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.radio label:hover {
  background: #f3f4f6;
}

.radio input[type="radio"] {
  width: auto;
  margin: 0;
  cursor: pointer;
}

/* í…Œì´ë¸” */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  font-size: 13px;
  overflow: hidden;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

th {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 14px;
  text-align: center;
  font-weight: 600;
}

td {
  border: 1px solid #e5e7eb;
  padding: 12px;
  text-align: left;
  background: white;
}

tr:hover td {
  background: #f9fafb;
}

/* ë¡œê·¸ì¸ í™”ë©´ */
.login-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: calc(100vh - 40px);
}

.login-card {
  max-width: 400px;
  width: 100%;
}

.login-card h2 {
  margin-bottom: 30px;
}

.login-info {
  background: #f0f9ff;
  padding: 15px;
  border-radius: 8px;
  margin-top: 20px;
  border-left: 4px solid #0284c7;
}

.login-info p {
  color: #0369a1;
  font-size: 14px;
  margin: 5px 0;
}


/* ë©”ë‰´ í™”ë©´ */
.menu-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
  margin-top: 20px;
}

.menu-grid button {
  width: 100%;
  padding: 20px;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.button-icon {
  font-size: 24px;
}

/* ê²€ìƒ‰ í¼ */
.search-form {
  background: #f9fafb;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  align-items: end;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group label {
  font-weight: 500;
  color: #374151;
  margin-bottom: 5px;
  font-size: 14px;
}

.action-buttons {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  justify-content: center;
  margin-top: 20px;
}

/* ë¹ˆ ìƒíƒœ */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #6b7280;
}

.empty-state-icon {
  font-size: 64px;
  margin-bottom: 20px;
  opacity: 0.5;
}

.welcome-banner {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  text-align: center;
}

.welcome-banner h3 {
  color: white;
  margin: 0;
  justify-content: center;
}

/* í†µê³„ ì¹´ë“œ */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.stat-card {
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  text-align: center;
  border-left: 4px solid #667eea;
}

.stat-card h4 {
  color: #6b7280;
  font-size: 14px;
  margin-bottom: 10px;
}

.stat-card .stat-value {
  font-size: 32px;
  font-weight: bold;
  color: #1f2937;
}

/* ë¡œë”© */
.loading {
  text-align: center;
  padding: 40px;
  color: white;
}

/* ë°˜ì‘í˜• */
@media (max-width: 768px) {
  .card {
    padding: 20px;
  }
  
  h2 {
    font-size: 24px;
  }
  
  h3 {
    font-size: 20px;
  }
  
  .radio {
    flex-direction: column;
    align-items: flex-start;
  }
  
  table {
    font-size: 11px;
  }
  
  th, td {
    padding: 8px;
  }
}

/* ì¸ì‡„ ìŠ¤íƒ€ì¼ */
@media print {
  body {
    background: white;
    padding: 0;
  }
  
  .btn-green, .btn-blue, .btn-gray, .btn-red {
    display: none;
  }
  
  .search-form {
    display: none;
  }
  
  .action-buttons {
    display: none;
  }
}
</style>
</head>

<body>
<div id="app">
  <div class="loading">
    <h2>â³ ë¡œë”© ì¤‘...</h2>
    <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
  </div>
</div>

<script>
(function() {
  'use strict';
  
  // ===== ì „ì—­ ë³€ìˆ˜ =====
  let supabase = null;
  let currentUser = null;
  let checklists = [];
  let isLoading = false;
  
  // ===== Supabase ì´ˆê¸°í™” =====
  function initSupabase() {
    try {
      if (typeof window.supabase === 'undefined') {
        console.error('Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return false;
      }
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      console.log('Supabase ì´ˆê¸°í™” ì™„ë£Œ');
      return true;
    } catch (error) {
      console.error('Supabase ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
      return false;
    }
  }
  
  // ===== ì„¸ì…˜ í™•ì¸ =====
  async function checkSession() {
    try {
      const { data: { session }, error } = await supabase.auth.getSession();
      
      if (error) throw error;
      
      if (session && session.user) {
        const metadata = session.user.user_metadata || {};
        currentUser = {
          id: session.user.id,
          email: session.user.email,
          name: metadata.name || session.user.email,
          facility: metadata.facility || 'all'
        };
        return true;
      }
      return false;
    } catch (error) {
      console.error('ì„¸ì…˜ í™•ì¸ ì˜¤ë¥˜:', error);
      return false;
    }
  }
  
  // ===== ë°ì´í„° ë¡œë“œ =====
  async function loadData() {
    try {
      isLoading = true;
      const { data, error } = await supabase
        .from('care')
        .select('*')
        .order('created_at', { ascending: false });
      
      if (error) throw error;
      
      checklists = (data || []).map(row => ({
        id: row.id,
        date: row.check_date,
        clientName: row.client,
        worker: row.worker,
        facility: row.facility,
        createdAt: row.created_at,
        health: row.info?.health || {},
        hygiene: row.info?.hygiene || {},
        meal: row.info?.meal || {},
        daily: row.info?.daily || {},
        med: row.info?.med || {},
        env: row.info?.env || {},
        special: row.info?.special || ''
      }));
      
      console.log('ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', checklists.length, 'ê±´');
      return true;
    } catch (error) {
      console.error('ë¡œë“œ ì˜¤ë¥˜:', error);
      alert('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
      return false;
    } finally {
      isLoading = false;
    }
  }
  
  // ===== ë°ì´í„° ì €ì¥ =====
  async function saveData(record) {
    try {
      isLoading = true;
      
      const { data: { user } } = await supabase.auth.getUser();
      
      const { data, error } = await supabase
        .from('care')
        .insert([{
          check_date: record.date,
          client: record.clientName,
          worker: record.worker,
          facility: record.facility,
          user_id: user?.id,
          info: {
            health: record.health,
            hygiene: record.hygiene,
            meal: record.meal,
            daily: record.daily,
            med: record.med,
            env: record.env,
            special: record.special
          }
        }])
        .select();
      
      if (error) throw error;
      
      alert('âœ… ì €ì¥ ì™„ë£Œ!');
      await loadData();
      showMenu();
      return true;
    } catch (error) {
      console.error('ì €ì¥ ì˜¤ë¥˜:', error);
      alert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
      return false;
    } finally {
      isLoading = false;
    }
  }
  
  // ===== ë°ì´í„° ì‚­ì œ =====
  async function deleteRecord(id) {
    const numId = Number(id);
    const record = checklists.find(r => r.id === numId);
    
    if (!record) {
      alert("âŒ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    
    const confirmMsg = `ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në‚ ì§œ: ${record.date}\nì´ìš©ì: ${record.clientName}\në‹´ë‹¹ì: ${record.worker}`;
    
    if (!confirm(confirmMsg)) return;
    
    try {
      isLoading = true;
      const { error } = await supabase
        .from('care')
        .delete()
        .eq('id', numId);
      
      if (error) throw error;
      
      alert('âœ… ì‚­ì œ ì™„ë£Œ');
      await loadData();
      search();
    } catch (error) {
      console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
      alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
    } finally {
      isLoading = false;
    }
  }
  
  // ===== ë¡œê·¸ì¸ í™”ë©´ =====
  function showLogin() {
    const app = document.getElementById('app');
    app.innerHTML = `
<div class="login-container">
  <div class="card login-card">
    <h2>ğŸ¥ ëŒë´„ ì ê²€ ê´€ë¦¬</h2>
    <div class="login-info" style="margin-bottom: 20px;">
      <p>ì§ì›ë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
    </div>
    <input id="email" type="email" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="username">
    <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="current-password">
    <button class="btn-blue" id="loginBtn" style="width:100%; margin-top:10px;">
      <span class="button-icon">ğŸ”</span> ë¡œê·¸ì¸
    </button>
  </div>
</div>`;
    
    document.getElementById('password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') login();
    });
    document.getElementById('loginBtn').addEventListener('click', login);
    
    setTimeout(() => document.getElementById('email').focus(), 100);
  }
  
  

  

  // ===== ë¡œê·¸ì¸ =====
  async function login() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    
    if (!email || !password) {
      alert("âš ï¸ ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    
    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email: email,
        password: password
      });
      
      if (error) throw error;
      
      if (data.user) {
        const metadata = data.user.user_metadata || {};
        currentUser = {
          id: data.user.id,
          email: data.user.email,
          name: metadata.name || data.user.email,
          facility: metadata.facility || 'all'
        };
        
        await loadData();
        showMenu();
      }
    } catch (error) {
      console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
      alert("âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
      document.getElementById('password').value = '';
      document.getElementById('password').focus();
    }
  }
  
  // ===== ë¡œê·¸ì•„ì›ƒ =====
  async function logout() {
    if (confirm("ğŸšª ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      try {
        await supabase.auth.signOut();
        currentUser = null;
        showLogin();
      } catch (error) {
        console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
        alert('âŒ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨');
      }
    }
  }
  
  // ===== í†µê³„ ê³„ì‚° =====
  function getStats() {
    const today = new Date().toISOString().split('T')[0];
    const thisWeekStart = new Date();
    thisWeekStart.setDate(thisWeekStart.getDate() - 7);
    const weekStartStr = thisWeekStart.toISOString().split('T')[0];
    
    let filteredChecklists = checklists;
    if (currentUser.facility !== "all") {
      filteredChecklists = checklists.filter(c => c.facility === currentUser.facility);
    }
    
    const todayCount = filteredChecklists.filter(c => c.date === today).length;
    const weekCount = filteredChecklists.filter(c => c.date >= weekStartStr).length;
    const totalCount = filteredChecklists.length;
    const uniqueClients = new Set(filteredChecklists.map(c => c.clientName)).size;
    
    return { todayCount, weekCount, totalCount, uniqueClients };
  }
  
  // ===== ë©”ë‰´ í™”ë©´ =====
  function showMenu() {
    const stats = getStats();
    const app = document.getElementById('app');
    
    app.innerHTML = `
<div class="container">
  <div class="welcome-banner">
    <h3>ğŸ‘‹ ${currentUser.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!</h3>
    ${currentUser.facility !== "all" ? `<p style="margin-top: 5px; opacity: 0.9;">ğŸ“ ${currentUser.facility}</p>` : '<p style="margin-top: 5px; opacity: 0.9;">ğŸ“ ì „ì²´ ì‹œì„¤ ê´€ë¦¬ì</p>'}
    <p style="margin-top: 10px; opacity: 0.9;">ì˜¤ëŠ˜ë„ ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”</p>
  </div>
  
  <div class="stats-grid">
    <div class="stat-card">
      <h4>ì˜¤ëŠ˜ ì‘ì„±</h4>
      <div class="stat-value">${stats.todayCount}</div>
    </div>
    <div class="stat-card">
      <h4>ì´ë²ˆ ì£¼</h4>
      <div class="stat-value">${stats.weekCount}</div>
    </div>
    <div class="stat-card">
      <h4>ì „ì²´ ê¸°ë¡</h4>
      <div class="stat-value">${stats.totalCount}</div>
    </div>
    <div class="stat-card">
      <h4>ì´ìš©ì ìˆ˜</h4>
      <div class="stat-value">${stats.uniqueClients}</div>
    </div>
  </div>
  
  <div class="card">
    <h3><span class="header-icon">ğŸ“‹</span> ë©”ì¸ ë©”ë‰´</h3>
    <div class="menu-grid">
      <button class="btn-green" id="checklistBtn">
        <span class="button-icon">âœï¸</span> ì ê²€í‘œ ì‘ì„±
      </button>
      <button class="btn-blue" id="searchBtn">
        <span class="button-icon">ğŸ”</span> ê¸°ë¡ ì¡°íšŒ
      </button>
      <button class="btn-red" id="logoutBtn">
        <span class="button-icon">ğŸšª</span> ë¡œê·¸ì•„ì›ƒ
      </button>
    </div>
  </div>
</div>`;
    
    document.getElementById('checklistBtn').addEventListener('click', showChecklist);
    document.getElementById('searchBtn').addEventListener('click', showSearch);
    document.getElementById('logoutBtn').addEventListener('click', logout);
  }
  
  // ===== ë¼ë””ì˜¤ ë²„íŠ¼ ìƒì„± =====
  function radio(label, name) {
    return `<div class="radio">
      <span class="radio-label">${label}</span>
      <label><input type="radio" name="${name}" value="ì–‘í˜¸" checked> âœ… ì–‘í˜¸</label>
      <label><input type="radio" name="${name}" value="ì¼ì§€"> ğŸ“ ì¼ì§€</label>
    </div>`;
  }
  
  // ===== ì ê²€í‘œ ì‘ì„± í™”ë©´ =====
  function showChecklist() {
    const today = new Date().toISOString().split('T')[0];
    const app = document.getElementById('app');
    
    app.innerHTML = `
<div class="container">
  <div class="card">
    <h3><span class="header-icon">âœï¸</span> ëŒë´„ ì ê²€í‘œ ì‘ì„±</h3>
    
    <div class="form-group">
      <label>ğŸ“… ì ê²€ ë‚ ì§œ *</label>
      <input type="date" id="c_date" value="${today}" required>
    </div>
    
    <div class="form-group">
      <label>ğŸ‘¤ ì´ìš©ìëª… *</label>
      <input placeholder="ì´ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”" id="c_client" required>
    </div>
    
    <div class="form-group">
      <label>ğŸ‘¨â€âš•ï¸ ì‘ì„± ì§ì›ëª… *</label>
      <input placeholder="ì§ì› ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" id="c_worker" value="${currentUser.name}" required>
    </div>

    <div class="section">
      <b><span class="section-icon">ğŸ’Š</span> ê±´ê°• ìƒíƒœ</b>
      <input placeholder="ì²´ì¤‘ (kg)" id="weight">
      <input placeholder="í˜ˆì•• (mmHg)" id="bp">
      <input placeholder="í˜ˆë‹¹ (mg/dL)" id="bs">
    </div>

    <div class="section">
      <b><span class="section-icon">ğŸ§¼</span> ìœ„ìƒ ê´€ë¦¬</b>
      ${radio("ì„¸ë©´", "wash")}
      ${radio("êµ¬ê°•", "dental")}
      ${radio("ë¨¸ë¦¬", "hair")}
      ${radio("ì†ë°œí†±", "nail")}
    </div>

    <div class="section">
      <b><span class="section-icon">ğŸ½ï¸</span> ì‹ì‚¬</b>
      <input placeholder="ì‹ë‹¨ ìš•êµ¬" id="menu">
      <div class="radio">
        <span class="radio-label">ì‹ì‚¬ ì„­ì·¨ëŸ‰</span>
        <label><input type="radio" name="meal_amount" value="ì†Œì‹"> ğŸš ì†Œì‹</label>
        <label><input type="radio" name="meal_amount" value="ë³´í†µ" checked> ğŸšğŸš ë³´í†µ</label>
        <label><input type="radio" name="meal_amount" value="ê³¼ì‹"> ğŸšğŸšğŸš ê³¼ì‹</label>
      </div>
      ${radio("ì‹ì‚¬ ì¤€ë¹„ ì°¸ì—¬", "prep")}
    </div>

    <div class="section">
      <b><span class="section-icon">ğŸ </span> ì¼ìƒ ìƒí™œ</b>
      ${radio("ì—­í•  í™œë™", "role")}
      ${radio("ì¹¨êµ¬ ì²­ê²°", "bed")}
      ${radio("ì˜ë³µ ì •ë¦¬", "cloth")}
      ${radio("ëŒ€í™”", "conv")}
    </div>

    <div class="section">
      <b><span class="section-icon">ğŸ’‰</span> íˆ¬ì•½ ê´€ë¦¬</b>
      <div class="radio">
        <span class="radio-label">ì•„ì¹¨ íˆ¬ì•½</span>
        <label><input type="radio" name="med_m" value="ì–‘í˜¸" checked> âœ… ì–‘í˜¸</label>
        <label><input type="radio" name="med_m" value="ì—†ìŒ"> âŒ ì—†ìŒ</label>
      </div>
      <div class="radio">
        <span class="radio-label">ì ì‹¬ íˆ¬ì•½</span>
        <label><input type="radio" name="med_a" value="ì–‘í˜¸" checked> âœ… ì–‘í˜¸</label>
        <label><input type="radio" name="med_a" value="ì—†ìŒ"> âŒ ì—†ìŒ</label>
      </div>
      <div class="radio">
        <span class="radio-label">ì €ë… íˆ¬ì•½</span>
        <label><input type="radio" name="med_e" value="ì–‘í˜¸" checked> âœ… ì–‘í˜¸</label>
        <label><input type="radio" name="med_e" value="ì—†ìŒ"> âŒ ì—†ìŒ</label>
      </div>
    </div>

    <div class="section">
      <b><span class="section-icon">âœ¨</span> ì™¸ëª¨ ê¾¸ë°ˆ</b>
      ${radio("í™”ì¥", "makeup")}
      ${radio("ì˜ë³µ", "clothes")}
      ${radio("ê°€ë°©", "bag")}
      ${radio("ì‹ ë°œ", "shoes")}
    </div>

    <div class="form-group">
      <label>ğŸ“ íŠ¹ì´ì‚¬í•­</label>
      <textarea id="special" placeholder="íŠ¹ì´ì‚¬í•­ì´ ìˆìœ¼ë©´ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    </div>

    <div class="action-buttons">
      <button class="btn-green" id="saveBtn">
        <span class="button-icon">ğŸ’¾</span> ì €ì¥
      </button>
      <button class="btn-blue" id="nextBtn">
        <span class="button-icon">â¡ï¸</span> ë‹¤ìŒ
      </button>
    </div>
  </div>
</div>`;
    
    document.getElementById('saveBtn').addEventListener('click', saveChecklist);
    document.getElementById('nextBtn').addEventListener('click', showMenu);
    
    setTimeout(() => document.getElementById('c_client').focus(), 100);
  }
  
  // ===== ì ê²€í‘œ ì €ì¥ =====
  async function saveChecklist() {
    function getRadioValue(name) {
      const elem = document.querySelector(`input[name="${name}"]:checked`);
      return elem ? elem.value : "ì–‘í˜¸";
    }
    
    const date = document.getElementById('c_date').value;
    const clientName = document.getElementById('c_client').value.trim();
    const workerName = document.getElementById('c_worker').value.trim();
    
    if (!date) {
      alert("âš ï¸ ì ê²€ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
      document.getElementById('c_date').focus();
      return;
    }
    
    if (!clientName) {
      alert("âš ï¸ ì´ìš©ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      document.getElementById('c_client').focus();
      return;
    }
    
    if (!workerName) {
      alert("âš ï¸ ì‘ì„± ì§ì›ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      document.getElementById('c_worker').focus();
      return;
    }
    
    const newRecord = {
      id: Date.now(),
      date: date,
      clientName: clientName,
      worker: workerName,
      facility: currentUser.facility,
      createdAt: new Date().toISOString(),
      health: {
        weight: document.getElementById('weight').value.trim(),
        bp: document.getElementById('bp').value.trim(),
        bs: document.getElementById('bs').value.trim()
      },
      hygiene: {
        wash: getRadioValue("wash"),
        dental: getRadioValue("dental"),
        hair: getRadioValue("hair"),
        nail: getRadioValue("nail")
      },
      meal: {
        menu: document.getElementById('menu').value.trim(),
        amount: getRadioValue("meal_amount"),
        prep: getRadioValue("prep")
      },
      daily: {
        role: getRadioValue("role"),
        bed: getRadioValue("bed"),
        cloth: getRadioValue("cloth"),
        conv: getRadioValue("conv")
      },
      med: {
        m: getRadioValue("med_m"),
        a: getRadioValue("med_a"),
        e: getRadioValue("med_e")
      },
      env: {
        clean: getRadioValue("clean"),
        vent: getRadioValue("vent"),
        temp: getRadioValue("temp"),
        safe: getRadioValue("safe")
      },
      special: document.getElementById('special').value.trim()
    };
    
    await saveData(newRecord);
  }
  
  // ===== ì¹´í…Œê³ ë¦¬ ìš”ì•½ =====
  function summaryCategory(obj) {
    const good = [];
    const log = [];
    const none = [];
    const name = {
      wash: "ì„¸ë©´", dental: "êµ¬ê°•ê´€ë¦¬", hair: "ë¨¸ë¦¬ì •ëˆ", nail: "ì†ë°œí†±ê´€ë¦¬",
      prep: "ì‹ì‚¬ì¤€ë¹„", role: "ì—­í• í™œë™", bed: "ì¹¨êµ¬ì •ëˆ", cloth: "ì˜ë³µì •ë¦¬", conv: "ëŒ€í™”",
      Grooming: "í™”ì¥", vent: "ì˜ë³µ", temp: "ê°€ë°©", safe: "ì‹ ë°œ", m: "ì•„ì¹¨", a: "ì ì‹¬", e: "ì €ë…"
    };
    
    for (let k in obj) {
      if (obj[k] === "ì–‘í˜¸") good.push(name[k])
      if (obj[k] === "ì¼ì§€") log.push(name[k]);
      if (obj[k] === "ì—†ìŒ") none.push(name[k]);
    }
    
    let result = `âœ… ì–‘í˜¸: ${good.join(", ") || "ì—†ìŒ"}`;
    if (log.length > 0) result += ` / ğŸ“ ì¼ì§€: ${log.join(", ")}`;
    if (none.length > 0) result += ` / âŒ ì—†ìŒ: ${none.join(", ")}`;
    
    return result;
  }
  
  // ===== ê¸°ë¡ ì¡°íšŒ í™”ë©´ =====
  async function showSearch() {
    const today = new Date();
    const past = new Date();
    past.setDate(today.getDate() - 7);
    
    const app = document.getElementById('app');
    app.innerHTML = `
<div class="container">
  <div class="card">
    <h3><span class="header-icon">ğŸ”</span> ê¸°ë¡ ì¡°íšŒ</h3>

    <div class="search-form">
      <div class="form-group">
        <label>ğŸ‘¤ ì´ìš©ìëª…</label>
        <input id="searchClient" placeholder="ì „ì²´">
      </div>
      <div class="form-group">
        <label>ğŸ“… ì‹œì‘ì¼</label>
        <input type="date" id="startDate" value="${past.toISOString().split('T')[0]}">
      </div>
      <div class="form-group">
        <label>ğŸ“… ì¢…ë£Œì¼</label>
        <input type="date" id="endDate" value="${today.toISOString().split('T')[0]}">
      </div>
    </div>

    <div class="action-buttons">
      <button class="btn-blue" id="refreshBtn">
        <span class="button-icon">ğŸ”„</span> ìƒˆë¡œê³ ì¹¨ & ì¡°íšŒ
      </button>
      <button class="btn-green" id="pdfBtn">
        <span class="button-icon">ğŸ“„</span> PDF ì €ì¥
      </button>
      <button class="btn-gray" id="backBtn">
        <span class="button-icon">â†©ï¸</span> ë’¤ë¡œ
      </button>
    </div>

    <div id="result"></div>
  </div>
</div>`;
    
    document.getElementById('refreshBtn').addEventListener('click', refreshAndSearch);
    document.getElementById('pdfBtn').addEventListener('click', savePDF);
    document.getElementById('backBtn').addEventListener('click', showMenu);
    
    await loadData();
    search();
  }
  
  // ===== ìƒˆë¡œê³ ì¹¨ & ì¡°íšŒ =====
  async function refreshAndSearch() {
    await loadData();
    search();
  }
  
  // ===== ê²€ìƒ‰ ì‹¤í–‰ =====
  function search() {
    const clientName = document.getElementById('searchClient').value.trim();
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    let filtered = checklists.filter(record => {
      const matchFacility = currentUser.facility === "all" || record.facility === currentUser.facility;
      const matchClient = !clientName || record.clientName.includes(clientName);
      const matchStart = !startDate || record.date >= startDate;
      const matchEnd = !endDate || record.date <= endDate;
      return matchFacility && matchClient && matchStart && matchEnd;
    });

    if (filtered.length === 0) {
      document.getElementById('result').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“­</div>
          <h3>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
          <p>ë‹¤ë¥¸ ì¡°ê±´ìœ¼ë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</p>
        </div>
      `;
      return;
    }

    filtered.sort((a, b) => {
      if (b.date !== a.date) return b.date.localeCompare(a.date);
      return b.id - a.id;
    });

    let html = `
      <div style="margin-bottom: 10px; color: #6b7280;">
        ğŸ“Š ì´ <strong style="color: #667eea;">${filtered.length}ê±´</strong>ì˜ ê¸°ë¡ì´ ì¡°íšŒë˜ì—ˆìŠµë‹ˆë‹¤.
      </div>
      <table>
        <tr>
          <th style="width: 100px;">ë‚ ì§œ</th>
          <th style="width: 100px;">ì´ìš©ì</th>
          <th style="width: 80px;">ë‹´ë‹¹ì</th>
          <th>ìƒì„¸ ë‚´ìš©</th>
          <th style="width: 80px;">ê´€ë¦¬</th>
        </tr>`;
    
    filtered.forEach(record => {
      html += `
      <tr>
        <td style="text-align:center; white-space:nowrap; font-weight: 600;">${record.date}</td>
        <td style="text-align:center; font-weight:600; color: #667eea;">${record.clientName}</td>
        <td style="text-align:center;">${record.worker}</td>
        <td>
          <div style="line-height:1.9; font-size: 13px;">
            ${record.health.weight || record.health.bp || record.health.bs ? 
              `<div style="margin-bottom: 8px;"><strong>ğŸ’Š ê±´ê°•:</strong> ì²´ì¤‘ ${record.health.weight || '-'} | í˜ˆì•• ${record.health.bp || '-'} | í˜ˆë‹¹ ${record.health.bs || '-'}</div>` : ''}
            ${record.meal.menu ? 
              `<div style="margin-bottom: 8px;"><strong>ğŸ½ï¸ ì‹ì‚¬:</strong> ${record.meal.menu} (ì„­ì·¨ëŸ‰: ${record.meal.amount})</div>` : ''}
            <div style="margin-bottom: 5px;"><strong>ğŸ§¼ ìœ„ìƒ:</strong> ${summaryCategory(record.hygiene)}</div>
            <div style="margin-bottom: 5px;"><strong>ğŸ  ì¼ìƒ:</strong> ${summaryCategory(record.daily)}</div>
            <div style="margin-bottom: 5px;"><strong>ğŸ’‰ íˆ¬ì•½:</strong> ${summaryCategory(record.med)}</div>
            <div style="margin-bottom: 5px;"><strong>âœ¨ ì™¸ëª¨:</strong> ${summaryCategory(record.env)}</div>
            ${record.special ? 
              `<div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-left: 3px solid #f59e0b; border-radius: 4px;">
                <strong style="color: #92400e;">ğŸ“Œ íŠ¹ì´ì‚¬í•­:</strong> ${record.special}
              </div>` : ''}
          </div>
        </td>
        <td style="text-align:center;">
          <button class="btn-red delete-btn" data-id="${record.id}" style="padding: 8px 12px; margin: 0;">
            ğŸ—‘ï¸ ì‚­ì œ
          </button>
        </td>
      </tr>`;
    });
    
    html += "</table>";
    document.getElementById('result').innerHTML = html;
    
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = e.currentTarget.getAttribute('data-id');
        deleteRecord(id);
      });
    });
  }
  
  // ===== PDF ì €ì¥ =====
  async function savePDF() {
    const resultDiv = document.getElementById('result');
    if (!resultDiv || !resultDiv.querySelector('table')) {
      alert('âš ï¸ ì¡°íšŒëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
      return;
    }
    
    if (typeof jspdf === 'undefined' || typeof html2canvas === 'undefined') {
      alert('âš ï¸ PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë”©í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    const { jsPDF } = jspdf;
    
    const searchClient = document.getElementById('searchClient').value.trim();
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    let filtered = checklists.filter(record => {
      const matchFacility = currentUser.facility === "all" || record.facility === currentUser.facility;
      const matchClient = !searchClient || record.clientName.includes(searchClient);
      const matchStart = !startDate || record.date >= startDate;
      const matchEnd = !endDate || record.date <= endDate;
      return matchFacility && matchClient && matchStart && matchEnd;
    });
    
    filtered.sort((a, b) => {
      if (b.date !== a.date) return b.date.localeCompare(a.date);
      return b.id - a.id;
    });
    
    if (filtered.length === 0) {
      alert('âš ï¸ ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    const pdfContainer = document.createElement('div');
    pdfContainer.style.cssText = `
      position: absolute;
      left: -9999px;
      width: 800px;
      background: white;
      padding: 40px;
      font-family: 'Malgun Gothic', Arial, sans-serif;
    `;
    
    let htmlContent = `
      <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #667eea; padding-bottom: 20px;">
        <h1 style="color: #1f2937; font-size: 32px; margin: 0;">ëŒë´„ ì ê²€ ê¸°ë¡</h1>
        <p style="color: #6b7280; margin-top: 15px; font-size: 16px;">ì¡°íšŒ ê¸°ê°„: ${startDate} ~ ${endDate}</p>
        ${searchClient ? `<p style="color: #6b7280; margin-top: 5px; font-size: 16px;">ì´ìš©ì: ${searchClient}</p>` : ''}
        <p style="color: #6b7280; margin-top: 5px; font-size: 14px;">ì´ ${filtered.length}ê±´ì˜ ê¸°ë¡</p>
      </div>
    `;
    
    filtered.forEach((record, index) => {
      htmlContent += `
        <div style="margin-bottom: 25px; border: 2px solid #667eea; border-radius: 8px; padding: 20px; page-break-inside: avoid; background: #fafafa;">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
            <strong style="font-size: 18px;">${record.date} | ${record.clientName}</strong>
            <span style="float: right; font-size: 14px;">ë‹´ë‹¹: ${record.worker}</span>
          </div>
          
          ${record.health.weight || record.health.bp || record.health.bs ? `
          <div style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 6px;">
            <strong style="color: #1f2937; font-size: 15px;">ğŸ’Š ê±´ê°• ìƒíƒœ:</strong>
            <span style="color: #4b5563; margin-left: 10px;">
              ì²´ì¤‘ ${record.health.weight || '-'} | 
              í˜ˆì•• ${record.health.bp || '-'} | 
              í˜ˆë‹¹ ${record.health.bs || '-'}
            </span>
          </div>
          ` : ''}
          
          ${record.meal.menu ? `
          <div style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 6px;">
            <strong style="color: #1f2937; font-size: 15px;">ğŸ½ï¸ ì‹ì‚¬:</strong>
            <span style="color: #4b5563; margin-left: 10px;">
              ${record.meal.menu} (ì„­ì·¨ëŸ‰: ${record.meal.amount})
            </span>
          </div>
          ` : ''}
          
          <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 6px;">
            <strong style="color: #1f2937; font-size: 14px;">ğŸ§¼ ìœ„ìƒ:</strong>
            <div style="color: #4b5563; margin-top: 5px; font-size: 13px;">${summaryCategory(record.hygiene)}</div>
          </div>
          
          <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 6px;">
            <strong style="color: #1f2937; font-size: 14px;">ğŸ  ì¼ìƒ:</strong>
            <div style="color: #4b5563; margin-top: 5px; font-size: 13px;">${summaryCategory(record.daily)}</div>
          </div>
          
          <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 6px;">
            <strong style="color: #1f2937; font-size: 14px;">ğŸ’‰ íˆ¬ì•½:</strong>
            <div style="color: #4b5563; margin-top: 5px; font-size: 13px;">${summaryCategory(record.med)}</div>
          </div>
          
          <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 6px;">
            <strong style="color: #1f2937; font-size: 14px;">âœ¨ ì™¸ëª¨:</strong>
            <div style="color: #4b5563; margin-top: 5px; font-size: 13px;">${summaryCategory(record.env)}</div>
          </div>
          
          ${record.special ? `
          <div style="margin-top: 12px; padding: 12px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 6px;">
            <strong style="color: #92400e; font-size: 14px;">ğŸ“Œ íŠ¹ì´ì‚¬í•­:</strong>
            <p style="color: #78350f; margin: 8px 0 0 0; line-height: 1.6;">${record.special}</p>
          </div>
          ` : ''}
        </div>
      `;
    });
    
    pdfContainer.innerHTML = htmlContent;
    document.body.appendChild(pdfContainer);
    
    try {
      const buttons = document.querySelectorAll('button');
      buttons.forEach(btn => btn.disabled = true);
      
      const canvas = await html2canvas(pdfContainer, {
        scale: 2,
        useCORS: true,
        logging: false,
        backgroundColor: '#ffffff'
      });
      
      const imgData = canvas.toDataURL('image/png');
      const imgWidth = 210;
      const pageHeight = 297;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      let heightLeft = imgHeight;
      
      const pdf = new jsPDF('p', 'mm', 'a4');
      let position = 0;
      
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
      
      while (heightLeft > 0) {
        position = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }
      
      const fileName = `ëŒë´„ì ê²€ê¸°ë¡_${searchClient || 'ì „ì²´'}_${startDate}_${endDate}.pdf`;
      pdf.save(fileName);
      
      buttons.forEach(btn => btn.disabled = false);
      alert('âœ… PDF íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
      
    } catch (error) {
      console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
      alert('âŒ PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      
      const buttons = document.querySelectorAll('button');
      buttons.forEach(btn => btn.disabled = false);
      
    } finally {
      if (document.body.contains(pdfContainer)) {
        document.body.removeChild(pdfContainer);
      }
    }
  }
  
  // ===== ì´ˆê¸°í™” =====
  async function init() {
    try {
      if (!initSupabase()) {
        document.getElementById('app').innerHTML = `
          <div class="container">
            <div class="card">
              <h2>âŒ ì˜¤ë¥˜</h2>
              <p style="text-align: center; color: #dc2626; margin-top: 20px;">
                Supabase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>
                í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.
              </p>
            </div>
          </div>
        `;
        return;
      }
      
      const hasSession = await checkSession();
      if (hasSession) {
        await loadData();
        showMenu();
      } else {
        showLogin();
      }
    } catch (error) {
      console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
      document.getElementById('app').innerHTML = `
        <div class="container">
          <div class="card">
            <h2>âŒ ì˜¤ë¥˜</h2>
            <p style="text-align: center; color: #dc2626; margin-top: 20px;">
              ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>
              í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.
            </p>
          </div>
        </div>
      `;
    }
  }
  
  window.onerror = function(msg, url, line) {
    console.error('ì „ì—­ ì˜¤ë¥˜:', msg, url, line);
    return false;
  };
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  
})();
</script>
</body>
</html>

